<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WAF Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: #0d1117;
            color: #f0f6fc;
            padding: 20px;
            font-family: 'Segoe UI', sans-serif;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            color: #c9d1d9;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            transition: transform .2s;
        }
        .card:hover { transform: scale(1.01); }
        .table thead th { background: #21262d; color: #c9d1d9; }
        .btn-custom { background: #238636; color: white; }
        .btn-custom:hover { background: #2ea043; }
        label { font-size: 0.9rem; color: #8b949e; margin-bottom: 4px; }
        input, select { font-size: 0.9rem; }
        .filter-section { display: flex; flex-wrap: wrap; gap: 10px; align-items: end; }
        .filter-section > div { flex: 1; min-width: 180px; }
        .filter-section .btn { height: 40px; }
        .table th, .table td { vertical-align: middle; }
        canvas { background: #0d1117; border-radius: 8px; padding: 10px; }
        .small-muted { color: #9aa5b1; font-size: .9rem; }
        .spinner { display: none; color: #58a6ff; text-align: center; }
        .live-alert { display: inline-block; background-color: #d73a49; color: white; font-weight: bold; padding: 4px 10px; border-radius: 20px; animation: blink 1.2s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        #toastContainer { position: fixed; top: 20px; right: 20px; z-index: 1055; }

        /* Popup styling */
        #attackAlert {
            position: fixed;
            bottom: 30px; right: 30px;
            background-color: #d73a49;
            color: white;
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
            display: none;
            z-index: 2000;
            animation: slideUp 0.6s ease-in-out;
            max-width: 360px;
            word-wrap: break-word;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .alert-controls { display:flex; gap:8px; align-items:center; }
        .severity-low { background-color: #2ea043 !important; }
        .severity-medium { background-color: #f39c12 !important; }
        .severity-high { background-color: #d73a49 !important; }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">üõ°Ô∏è Web Application Firewall Dashboard</h2>
        <div class="d-flex align-items-center">
            <div class="me-3"><span class="badge bg-info text-dark">Live Logs: <span id="liveLogCount">0</span></span></div>
            <div class="me-3"><span id="alertIndicator" class="live-alert" style="display:none;">‚ö†Ô∏è Attack Detected</span></div>
            <div class="alert-controls">
                <button id="enableAlertsBtn" class="btn btn-sm btn-outline-light">Enable Alerts</button>
                <button id="testAlertBtn" class="btn btn-sm btn-outline-primary">Test Alert</button>
            </div>
        </div>
    </div>

    <!-- Rules Section -->
    <div class="card p-3 mb-4">
        <h4>Configured Rules</h4>
        {% if added %}<div class="alert alert-success py-2">‚úÖ Rule added successfully.</div>{% elif error %}<div class="alert alert-danger py-2">‚ö†Ô∏è {{ error | safe }}</div>{% endif %}
        <table class="table table-striped table-dark">
            <thead><tr><th>ID</th><th>Description</th><th>Condition</th><th>Action</th><th>Delete</th></tr></thead>
            <tbody>
                {% for rule in rules %}
                <tr><td>{{ rule.id }}</td><td>{{ rule.description }}</td><td>{{ rule.condition }}</td><td>{{ rule.action }}</td>
                    <td><form method="POST" action="{{ url_for('routes.delete_rule', rule_id=rule.id) }}"><button class="btn btn-danger btn-sm w-100">Delete</button></form></td></tr>
                {% endfor %}
            </tbody>
        </table>
        <form class="row g-2" method="POST" action="{{ url_for('routes.add_rule') }}">
            <div class="col-md-3"><input name="description" class="form-control" placeholder="Description" required></div>
            <div class="col-md-3"><input name="condition" class="form-control" placeholder="Condition (Regex or plain)" required></div>
            <div class="col-md-2"><select name="pattern_type" class="form-select"><option value="regex" selected>Regex</option><option value="plain">Plain</option></select></div>
            <div class="col-md-2"><select name="action" class="form-select" required><option value="">Select Action</option><option value="block">Block</option><option value="allow">Allow</option><option value="alert">Alert</option></select></div>
            <div class="col-md-2"><button class="btn btn-custom w-100">Add Rule</button></div>
        </form>
    </div>

    <!-- Logs Section -->
    <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div><h4 class="mb-0">Recent Logs</h4><div class="small-muted">Auto-refresh every 10s ‚Ä¢ Use filters to narrow results</div></div>
            <div><button id="refreshBtn" class="btn btn-outline-info btn-sm me-2">üîÑ Refresh</button><button id="simulateAttack" class="btn btn-warning btn-sm">‚ö° Simulate Attack</button></div>
        </div>

        <div class="filter-section mb-3">
            <div><label>Search (IP, URL, Reason)</label><input id="logSearch" class="form-control" placeholder="Enter keyword"></div>
            <div><label>From Date</label><input id="dateFrom" type="date" class="form-control"></div>
            <div><label>To Date</label><input id="dateTo" type="date" class="form-control"></div>
            <div><label>Per Page</label><select id="perPage" class="form-select"><option>10</option><option>25</option><option>50</option></select></div>
            <div><label>&nbsp;</label><button id="exportBtn" class="btn btn-outline-light w-100">Export</button></div>
        </div>

        <div class="spinner" id="loadingSpinner"><div class="spinner-border text-info" role="status"></div><div>Loading logs...</div></div>
        <table class="table table-striped table-dark" id="logsTable"><thead><tr><th>ID</th><th>Timestamp</th><th>IP</th><th>URL</th><th>Reason</th></tr></thead><tbody></tbody></table>

        <div class="d-flex justify-content-between align-items-center">
            <div id="paginationInfo" class="small text-secondary"></div>
            <div><button id="prevPage" class="btn btn-secondary btn-sm me-2">Prev</button><button id="nextPage" class="btn btn-secondary btn-sm">Next</button></div>
        </div>

        <hr><h5>üìä Attack Analytics</h5>
        <div class="row"><div class="col-md-6 mb-3"><canvas id="reasonChart" height="200"></canvas></div><div class="col-md-6 mb-3"><canvas id="ipChart" height="200"></canvas></div></div>
    </div>
</div>

<!-- Real-Time Attack Popup -->
<div id="attackAlert" class="severity-high">
    ‚ö†Ô∏è <strong>New Attack Detected!</strong><br>
    <span id="alertDetails"></span><br>
    <button id="dismissAlert" class="btn btn-light btn-sm mt-2">Dismiss</button>
</div>

<div id="toastContainer"></div>
<audio id="alertSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_6f494b97cf.mp3?filename=notification-2-27395.mp3" preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let logsPage = 1, reasonChart=null, ipChart=null, refreshInterval, lastSeenLogId=0, alertsEnabled=false, eventSource=null;

    function playAlertSound(){ if(!alertsEnabled)return; const s=document.getElementById('alertSound'); s.currentTime=0; s.play().catch(()=>{}); }
    function showToast(m,t='info'){const id='t'+Date.now();const c=t==='success'?'bg-success':t==='error'?'bg-danger':'bg-info';const el=document.createElement('div');el.className=`toast text-white ${c} show mb-2`;el.innerHTML=`<div class='d-flex'><div class='toast-body'>${m}</div><button class='btn-close btn-close-white me-2 m-auto'></button></div>`;document.getElementById('toastContainer').appendChild(el);setTimeout(()=>el.remove(),5000);}

    function showAttackAlert(details,severity=80){
        const box=document.getElementById('attackAlert');
        document.getElementById('alertDetails').innerText=details;
        box.classList.remove('severity-low','severity-medium','severity-high');
        if(severity<50)box.classList.add('severity-low');
        else if(severity<80)box.classList.add('severity-medium');
        else box.classList.add('severity-high');
        box.style.display='block';
        playAlertSound();
        setTimeout(()=>{box.style.display='none';},7000);
    }

    document.getElementById('dismissAlert').onclick=()=>document.getElementById('attackAlert').style.display='none';
    document.getElementById('enableAlertsBtn').onclick=()=>{alertsEnabled=true;showToast('Alerts enabled','success');document.getElementById('enableAlertsBtn').disabled=true;setupAlertStream();};
    document.getElementById('testAlertBtn').onclick=()=>{alertsEnabled=true;showAttackAlert('Test alert - this is a test.',60);showToast('Test alert fired.','info');};

    function setupAlertStream(){
        try{
            eventSource=new EventSource('/stream_alerts');
            eventSource.onmessage=(e)=>{
                const p=JSON.parse(e.data||'{}');
                const msg=`IP: ${p.ip||'unknown'} | ${p.reason||'Attack detected'} | Severity: ${p.severity||'?'}`;
                showAttackAlert(msg,p.severity||80);
                showToast(`Realtime alert: ${p.reason||'attack'}`,'error');
                loadLogs(1);setTimeout(loadStats,500);
            };
            eventSource.onerror=()=>{eventSource.close();eventSource=null;showToast('SSE disconnected, using polling.','info');};
            showToast('Connected to realtime alerts (SSE).','success');
        }catch(e){showToast('SSE failed, using polling','info');}
    }

    async function pollAlertsOnce(){
        try{
            const r=await fetch('/api/alerts');if(!r.ok)return;
            const a=await r.json();if(!a||!a.length)return;
            const l=a[a.length-1];showAttackAlert(`IP: ${l.ip} | ${l.reason}`,l.severity||70);
        }catch(e){}
    }

    async function loadLogs(p=1){
        const s=document.getElementById('loadingSpinner');s.style.display="block";
        const q=document.getElementById('logSearch').value.trim(),from=document.getElementById('dateFrom').value,to=document.getElementById('dateTo').value;
        const per=parseInt(document.getElementById('perPage').value)||10;
        try{
            const res=await fetch(`/api/logs?q=${encodeURIComponent(q)}&page=${p}&per_page=${per}&from=${from}&to=${to}`);
            const d=await res.json(),tb=document.querySelector('#logsTable tbody');tb.innerHTML="";
            if(!d.items.length)tb.innerHTML='<tr><td colspan=5 class=text-center>No logs found</td></tr>';
            else d.items.forEach(l=>tb.innerHTML+=`<tr><td>${l.id}</td><td>${l.timestamp}</td><td>${l.ip}</td><td>${l.url}</td><td>${l.reason}</td></tr>`);
            document.getElementById('liveLogCount').innerText=d.total;
            logsPage=d.page;
        }catch(e){showToast('Error loading logs','error');}finally{s.style.display="none";}
    }

    async function loadStats(){
        const r1=await fetch('/api/logs/stats');const s1=await r1.json();
        if(reasonChart)reasonChart.destroy();
        reasonChart=new Chart(document.getElementById('reasonChart'),{type:'bar',data:{labels:s1.map(x=>x.reason),datasets:[{data:s1.map(x=>x.count),backgroundColor:'#f39c12'}]},options:{plugins:{legend:{display:false}}}});
        const r2=await fetch('/api/logs/top_ips');const s2=await r2.json();
        if(ipChart)ipChart.destroy();
        ipChart=new Chart(document.getElementById('ipChart'),{type:'pie',data:{labels:s2.map(x=>x.ip),datasets:[{data:s2.map(x=>x.count)}]}});
    }

    document.getElementById('simulateAttack').onclick=async()=>{await fetch('/simulate_attack',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'SQL Injection'})});showToast('Attack simulation triggered','success');loadLogs(1);loadStats();};
    document.getElementById('refreshBtn').onclick=()=>{loadLogs(logsPage);loadStats();showToast('Data refreshed','info');};
    document.getElementById('logSearch').onkeyup=()=>loadLogs(1);
    document.getElementById('perPage').onchange=()=>loadLogs(1);
    document.getElementById('prevPage').onclick=()=>loadLogs(Math.max(1,logsPage-1));
    document.getElementById('nextPage').onclick=()=>loadLogs(logsPage+1);
    document.getElementById('exportBtn').onclick=()=>{const q=document.getElementById('logSearch').value.trim(),f=document.getElementById('dateFrom').value,t=document.getElementById('dateTo').value;window.location=`/export_logs?q=${encodeURIComponent(q)}&from=${f}&to=${t}`;};

    function startAutoRefresh(){if(refreshInterval)clearInterval(refreshInterval);refreshInterval=setInterval(()=>{loadLogs(logsPage);loadStats();if(!eventSource)pollAlertsOnce();},10000);}
    (function init(){setupAlertStream();loadLogs();loadStats();pollAlertsOnce();startAutoRefresh();})();
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

